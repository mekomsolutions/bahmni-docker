name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Start Terraform infrastructure
        run: |
          export TF_VAR_aws_api_key='${{ secrets.AWS_API_KEY_1 }}'
          export TF_VAR_aws_api_secret='${{ secrets.AWS_API_SECRET_1 }}'
          ./build/scripts/start_terraform.sh

      - name: Parse services
        run: ./build/scripts/parse_services.sh

      - name: Copy files
        run: ./build/scripts/copy_files.sh

      - name: Build images on remote instances
        if: ${{ true }}
        run: ./build/scripts/build_images.sh

      - name: Deploy images on Docker Hub
        run: ./build/scripts/push_images.sh

      - name: Destroy Terraform infrastructure
        if: always()
        run: |
          export TF_VAR_aws_api_key='${{ secrets.AWS_API_KEY_1 }}'
          export TF_VAR_aws_api_secret='${{ secrets.AWS_API_SECRET_1 }}'
          ./build/scripts/destroy_terraform.sh
